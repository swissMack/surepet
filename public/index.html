<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SurePet Curfew</title>
<link rel="icon" type="image/x-icon" href="favicon.ico" id="favicon">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<link href="https://unpkg.com/primeicons@7.0.0/primeicons.css" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg-deep:#f2f4f7;--bg-base:#e8eaed;--bg-card:#ffffff;--bg-card-hover:#f8f9fa;
  --bg-input:#ffffff;--border:#e0e0e0;--border-focus:#03a9f444;
  --text-primary:#212121;--text-secondary:#727272;--text-muted:#9e9e9e;
  --amber:#03a9f4;--amber-dim:#0288d1;--amber-glow:#03a9f422;
  --teal:#00bcd4;--teal-dim:#0097a7;
  --rose:#f44336;--rose-dim:#c62828;
  --emerald:#4caf50;--emerald-dim:#388e3c;
  --radius:12px;--radius-sm:6px;
}
html{font-size:15px;scroll-behavior:smooth}
body{
  font-family:'DM Sans',sans-serif;background:var(--bg-deep);color:var(--text-primary);
  min-height:100vh;overflow-x:hidden;
  background-image:none;
}

/* ── Header ── */
.header{
  position:sticky;top:0;z-index:50;
  padding:1rem 1.5rem;
  background:#ffffff;
  border-bottom:1px solid var(--border);
  backdrop-filter:blur(20px);
  box-shadow:0 1px 4px #0000000a;
  display:flex;align-items:center;justify-content:space-between;gap:1rem;
  flex-wrap:wrap;
}
.header-left{display:flex;align-items:center;gap:.75rem}
.logo{
  width:36px;height:36px;
  background:linear-gradient(135deg,var(--amber),#0277bd);
  border-radius:10px;display:grid;place-items:center;
  font-size:1.2rem;line-height:1;
  box-shadow:0 0 20px var(--amber-glow);
}
.header h1{font-family:'Outfit',sans-serif;font-weight:700;font-size:1.25rem;letter-spacing:-.02em}
.header h1 span{color:var(--amber);font-weight:800}
.header-meta{display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
.meta-pill{
  font-size:.75rem;color:var(--text-secondary);
  background:var(--bg-card);border:1px solid var(--border);
  padding:.35rem .7rem;border-radius:20px;
  display:flex;align-items:center;gap:.4rem;
}
.meta-pill .dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.dot-green{background:var(--emerald);box-shadow:0 0 6px var(--emerald)}
.dot-red{background:var(--rose);box-shadow:0 0 6px var(--rose)}
.dot-amber{background:var(--amber);box-shadow:0 0 6px var(--amber)}
.btn-sync{
  background:none;border:1px solid var(--border);color:var(--text-secondary);
  padding:.35rem .7rem;border-radius:20px;cursor:pointer;font-size:.75rem;
  font-family:'DM Sans',sans-serif;transition:all .2s;
  display:flex;align-items:center;gap:.35rem;
}
.btn-sync:hover{border-color:var(--amber);color:var(--amber)}
.btn-sync.syncing{opacity:.5;pointer-events:none}
.btn-sync .pi{font-size:.8rem}

/* ── Layout ── */
.container{max-width:1100px;margin:0 auto;padding:1.5rem}
.section-title{
  font-family:'Outfit',sans-serif;font-weight:600;font-size:1rem;
  color:var(--text-secondary);letter-spacing:.04em;text-transform:uppercase;
  margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;
}
.section-title::before{content:'';display:block;width:3px;height:14px;border-radius:2px;background:var(--amber)}
.section-title.collapsible{
  cursor:pointer;user-select:none;justify-content:space-between;
  background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);
  padding:.75rem 1rem;margin-bottom:.5rem;transition:all .2s;
}
.section-title.collapsible:hover{color:var(--amber);border-color:var(--amber)}
.section-title.collapsible.open{border-bottom-left-radius:0;border-bottom-right-radius:0;margin-bottom:0;border-bottom-color:transparent}
.section-title.collapsible + .panel-body:not(.collapsed){border-top-left-radius:0;border-top-right-radius:0}
.panel-arrow{font-size:.7rem;transition:transform .25s}
.section-title.open .panel-arrow{transform:rotate(180deg)}
.panel-body{transition:max-height .3s ease,opacity .25s ease,margin .3s ease;overflow:hidden}
.panel-body.collapsed{max-height:0;opacity:0;margin-bottom:0;padding:0;border:none}
.grid-cats{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem;margin-bottom:2rem}

/* ── Cat Card ── */
.cat-card{
  background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);
  padding:1.25rem;position:relative;overflow:hidden;
  transition:border-color .25s,box-shadow .25s;
}
.cat-card:hover{border-color:var(--amber);box-shadow:0 4px 16px #03a9f418}
.cat-card.curfew-on{border-color:var(--rose-dim)}
.cat-card.curfew-on::after{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--rose),var(--rose-dim));
}
.cat-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:.85rem}
.cat-name{font-family:'Outfit',sans-serif;font-weight:700;font-size:1.35rem;letter-spacing:-.01em}
.cat-location{
  font-size:.7rem;font-weight:600;letter-spacing:.04em;text-transform:uppercase;
  padding:.3rem .6rem;border-radius:20px;display:flex;align-items:center;gap:.35rem;
}
.loc-inside{background:#44d9e218;color:var(--teal)}
.loc-outside{background:#03a9f418;color:var(--amber)}
.loc-unknown{background:#9e9e9e18;color:var(--text-muted)}
.loc-toggle{
  display:flex;align-items:center;gap:.4rem;
}
.loc-switch{
  position:relative;width:40px;height:22px;border-radius:11px;
  background:var(--teal);border:none;cursor:pointer;transition:background .25s;
  flex-shrink:0;
}
.loc-switch.outside{background:var(--amber)}
.loc-switch::after{
  content:'';position:absolute;top:2px;left:2px;
  width:18px;height:18px;border-radius:50%;background:#fff;
  transition:transform .25s;box-shadow:0 1px 3px #0003;
}
.loc-switch.outside::after{transform:translateX(18px)}
.loc-switch:disabled{opacity:.5;cursor:not-allowed}
.cat-status{
  display:flex;align-items:center;gap:.5rem;margin-bottom:1rem;
  font-size:.8rem;color:var(--text-secondary);
}
.curfew-badge{
  padding:.25rem .55rem;border-radius:6px;font-size:.7rem;font-weight:600;
  letter-spacing:.02em;text-transform:uppercase;
}
.curfew-badge.active{background:#f43f5e20;color:var(--rose)}
.curfew-badge.inactive{background:#10b98118;color:var(--emerald)}
.profile-tag{font-size:.7rem;color:var(--text-muted)}
.cat-actions{display:flex;gap:.5rem;margin-bottom:.85rem}
.btn{
  font-family:'DM Sans',sans-serif;font-size:.75rem;font-weight:600;
  padding:.45rem .85rem;border-radius:var(--radius-sm);border:none;
  cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:.3rem;
}
.btn:disabled{opacity:.4;pointer-events:none}
.btn-lock{background:var(--rose-dim);color:#fff}
.btn-lock:hover{background:var(--rose);box-shadow:0 0 16px #f43f5e33}
.btn-unlock{background:var(--emerald-dim);color:#fff}
.btn-unlock:hover{background:var(--emerald);box-shadow:0 0 16px #10b98133}

/* schedules inside cat card */
.cat-schedules{border-top:1px solid var(--border);padding-top:.75rem;margin-top:.5rem}
.cat-schedules-label{font-size:.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.4rem;font-weight:600}
.sched-row{
  display:flex;align-items:center;justify-content:space-between;gap:.5rem;
  padding:.35rem 0;font-size:.78rem;
}
.sched-info{display:flex;align-items:center;gap:.4rem;flex:1;min-width:0}
.sched-name{color:var(--text-primary);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sched-time{color:var(--amber);font-family:'Outfit',sans-serif;font-weight:600;font-size:.75rem;white-space:nowrap}
.sched-days{color:var(--text-muted);font-size:.65rem;letter-spacing:.02em}
.sched-actions{display:flex;gap:.3rem;flex-shrink:0}
.btn-xs{
  background:none;border:1px solid var(--border);color:var(--text-secondary);
  width:26px;height:26px;border-radius:6px;cursor:pointer;
  display:grid;place-items:center;font-size:.7rem;transition:all .2s;
}
.btn-xs:hover{border-color:var(--amber);color:var(--amber)}
.btn-xs.off{opacity:.4}
.btn-xs.del:hover{border-color:var(--rose);color:var(--rose)}

/* ── Device Card ── */
.grid-devices{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem;margin-bottom:2rem}
.device-card{
  background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);
  padding:1.25rem;
}
.device-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
.device-name{font-family:'Outfit',sans-serif;font-weight:600;font-size:1.1rem}
.device-online{font-size:.7rem;font-weight:600;padding:.25rem .5rem;border-radius:20px}
.online-yes{background:#10b98118;color:var(--emerald)}
.online-no{background:#f43f5e18;color:var(--rose)}
.device-stats{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
.stat{display:flex;flex-direction:column;gap:.3rem}
.stat-label{font-size:.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;font-weight:600}
.stat-value{font-family:'Outfit',sans-serif;font-weight:600;font-size:1rem}
.battery-bar{
  width:100%;height:6px;background:var(--bg-deep);border-radius:3px;overflow:hidden;
  margin-top:.25rem;
}
.battery-fill{height:100%;border-radius:3px;transition:width .5s}
.batt-good{background:linear-gradient(90deg,var(--emerald),var(--teal))}
.batt-mid{background:linear-gradient(90deg,var(--amber),#0288d1)}
.batt-low{background:linear-gradient(90deg,var(--rose),#ff7043)}

/* ── New Schedule Form ── */
.form-section{
  background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);
  padding:1.25rem;margin-bottom:2rem;
}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
@media(max-width:600px){.form-grid{grid-template-columns:1fr}}
.form-group{display:flex;flex-direction:column;gap:.3rem}
.form-group.full{grid-column:1/-1}
.form-label{font-size:.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;font-weight:600}
.form-input,.form-select{
  background:var(--bg-input);border:1px solid var(--border);color:var(--text-primary);
  padding:.55rem .75rem;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;
  font-size:.85rem;transition:border-color .2s;outline:none;
}
.form-input:focus,.form-select:focus{border-color:var(--amber)}
.form-select option{background:var(--bg-card);color:var(--text-primary)}
.days-row{display:flex;gap:.35rem;flex-wrap:wrap}
.day-check{
  width:36px;height:32px;border-radius:6px;
  background:var(--bg-input);border:1px solid var(--border);
  color:var(--text-muted);font-size:.7rem;font-weight:600;
  display:grid;place-items:center;cursor:pointer;transition:all .2s;
  user-select:none;font-family:'Outfit',sans-serif;
}
.day-check.selected{background:var(--amber);color:#fff;border-color:var(--amber)}
.btn-submit{
  background:linear-gradient(135deg,var(--amber),#0277bd);color:#fff;
  font-weight:700;padding:.6rem 1.5rem;border-radius:var(--radius-sm);
  border:none;cursor:pointer;font-family:'Outfit',sans-serif;font-size:.85rem;
  letter-spacing:.01em;transition:all .2s;margin-top:.5rem;
}
.btn-submit:hover{box-shadow:0 0 24px var(--amber-glow);transform:translateY(-1px)}
.btn-submit:disabled{opacity:.4;pointer-events:none}

/* ── Events Log ── */
.events-section{margin-bottom:2rem}
.events-list{
  background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);
  overflow:hidden;
}
.event-row{
  display:flex;align-items:center;gap:.75rem;
  padding:.65rem 1rem;border-bottom:1px solid var(--border);
  font-size:.78rem;transition:background .15s;
}
.event-row:last-child{border-bottom:none}
.event-row:hover{background:#03a9f408}
.event-time{color:var(--text-muted);font-family:'Outfit',sans-serif;font-size:.7rem;white-space:nowrap;min-width:70px}
.event-type{
  font-weight:600;font-size:.65rem;letter-spacing:.03em;text-transform:uppercase;
  padding:.2rem .45rem;border-radius:4px;white-space:nowrap;
}
.et-curfew_activated,.et-cron_lock{background:#f43f5e18;color:var(--rose)}
.et-curfew_deactivated,.et-cron_unlock{background:#10b98118;color:var(--emerald)}
.et-cat_movement{background:#44d9e218;color:var(--teal)}
.et-device_online,.et-device_discovered,.et-cat_discovered{background:#03a9f418;color:var(--amber)}
.et-device_offline,.et-curfew_error{background:#f43f5e18;color:var(--rose)}
.et-manual_location{background:#8b5cf618;color:#a78bfa}
.et-device_lock_changed{background:#8b5cf618;color:#a78bfa}
.event-detail{color:var(--text-secondary);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ── Toast ── */
.toast{
  position:fixed;bottom:1.5rem;right:1.5rem;z-index:100;
  background:var(--bg-card);border:1px solid var(--border);
  padding:.75rem 1.1rem;border-radius:var(--radius-sm);
  font-size:.8rem;color:var(--text-primary);
  box-shadow:0 4px 16px #00000015;
  transform:translateY(120%);opacity:0;transition:all .35s cubic-bezier(.34,1.56,.64,1);
  max-width:340px;
}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{border-color:var(--emerald-dim)}
.toast.error{border-color:var(--rose-dim)}

/* ── Empty ── */
.empty{text-align:center;padding:2rem;color:var(--text-muted);font-size:.85rem}

/* ── Signal strength colours ── */
.sig-good{color:var(--emerald)}
.sig-mid{color:var(--amber)}
.sig-weak{color:var(--rose)}

/* ── Responsive ── */
@media(max-width:500px){
  .header{padding:.75rem 1rem}
  .container{padding:1rem}
  .grid-cats,.grid-devices{grid-template-columns:1fr}
  .cat-name{font-size:1.15rem}
}

/* ── Header nav icons ── */
.header-nav{display:flex;align-items:center;gap:.35rem}
.nav-btn{
  background:none;border:1px solid var(--border);color:var(--text-secondary);
  width:34px;height:34px;border-radius:8px;cursor:pointer;
  display:grid;place-items:center;font-size:1rem;transition:all .2s;
}
.nav-btn:hover,.nav-btn.active{border-color:var(--amber);color:var(--amber);background:var(--amber-glow)}

/* ── View toggle ── */
.view{display:none}.view.active{display:block}

/* ── Settings/Help page ── */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
@media(max-width:600px){.settings-grid{grid-template-columns:1fr}}
.settings-section{
  background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);
  padding:1.25rem;margin-bottom:1rem;
}
.settings-section h3{font-family:'Outfit',sans-serif;font-weight:600;font-size:.95rem;margin-bottom:.75rem;display:flex;align-items:center;gap:.4rem}
.help-content{
  background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);
  padding:1.5rem;line-height:1.7;font-size:.85rem;
}
.help-content h2{font-family:'Outfit',sans-serif;font-weight:700;font-size:1.1rem;margin:1.25rem 0 .5rem;color:var(--amber)}
.help-content h2:first-child{margin-top:0}
.help-content p{margin-bottom:.75rem;color:var(--text-secondary)}
.help-content ul{margin-left:1.25rem;margin-bottom:.75rem;color:var(--text-secondary)}
.help-content li{margin-bottom:.25rem}
.help-content code{background:var(--bg-deep);padding:.15rem .4rem;border-radius:3px;font-size:.8rem}

/* ── Skeleton loading ── */
.skeleton{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;position:relative;overflow:hidden}
.skeleton::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,#00000008,transparent);animation:shimmer 1.5s infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.skel-line{height:12px;background:var(--bg-deep);border-radius:4px;margin-bottom:.5rem}
.skel-line.w60{width:60%}.skel-line.w40{width:40%}.skel-line.w80{width:80%}
.skel-line.h20{height:20px}

/* ── Animations ── */
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.cat-card,.device-card,.form-section,.events-list{animation:fadeUp .4s ease-out both}
.cat-card:nth-child(2){animation-delay:.06s}
.cat-card:nth-child(3){animation-delay:.12s}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo"><img id="logoImg" src="paw-logo.png" alt="SurePet" style="width:22px;height:22px;filter:brightness(0) invert(1)"></div>
    <h1>Sure<span>Pet</span> Curfew</h1>
  </div>
  <div style="display:flex;align-items:center;gap:.75rem;flex-wrap:wrap">
    <div class="header-meta" id="headerMeta"></div>
    <div class="header-nav">
      <button class="nav-btn active" id="navDash" title="Dashboard" onclick="showView('dashboard')"><i class="pi pi-home"></i></button>
      <button class="nav-btn" id="navSettings" title="Settings" onclick="showView('settings')"><i class="pi pi-cog"></i></button>
      <button class="nav-btn" id="navHelp" title="Help" onclick="showView('help')"><i class="pi pi-question-circle"></i></button>
    </div>
  </div>
</div>

<div class="container">

<!-- Dashboard View -->
<div class="view active" id="viewDashboard">
  <div class="section-title">Cats</div>
  <div class="grid-cats" id="catGrid"></div>

  <div class="section-title">Devices</div>
  <div class="grid-devices" id="deviceGrid"></div>

  <div class="section-title collapsible" onclick="togglePanel('schedPanel',this)">
    <span>New Schedule</span>
    <i class="pi pi-chevron-down panel-arrow"></i>
  </div>
  <div class="form-section panel-body collapsed" id="schedPanel">
    <form id="schedForm" class="form-grid">
      <div class="form-group">
        <label class="form-label">Cat</label>
        <select class="form-select" id="fCat" required></select>
      </div>
      <div class="form-group">
        <label class="form-label">Schedule Name</label>
        <input class="form-input" id="fName" placeholder="e.g. Night curfew" required>
      </div>
      <div class="form-group">
        <label class="form-label">Lock Time</label>
        <input class="form-input" type="time" id="fLock" value="21:00" required>
      </div>
      <div class="form-group">
        <label class="form-label">Unlock Time</label>
        <input class="form-input" type="time" id="fUnlock" value="07:00" required>
      </div>
      <div class="form-group full">
        <label class="form-label">Days</label>
        <div class="days-row" id="fDays"></div>
      </div>
      <div class="form-group full" style="display:flex;gap:.5rem;align-items:center">
        <button type="submit" class="btn-submit" id="fSubmit">Create Schedule</button>
        <button type="button" class="btn-submit" id="fCancel" style="background:#9e9e9e;display:none" onclick="cancelEdit()">Cancel</button>
      </div>
    </form>
  </div>

  <div class="section-title">Recent Events</div>
  <div class="events-section">
    <div class="events-list" id="eventList"></div>
  </div>
</div><!-- /viewDashboard -->

<!-- Settings View -->
<div class="view" id="viewSettings">
  <div class="section-title"><i class="pi pi-cog"></i> Settings</div>
  <div id="settingsContent">
    <div class="empty"><i class="pi pi-spin pi-spinner"></i> Loading settings…</div>
  </div>
</div>

<!-- Help View -->
<div class="view" id="viewHelp">
  <div class="section-title"><i class="pi pi-question-circle"></i> Help</div>
  <div class="help-content">
    <h2>What is SurePet Curfew?</h2>
    <p>SurePet Curfew lets you create independent, per-cat curfew schedules for your Sure Petcare DualScan cat flaps. Each cat can have its own lock/unlock times on chosen days of the week.</p>

    <h2>How Profiles Work</h2>
    <ul>
      <li><b>Full Access</b> — Cat can go in and out freely (profile 2)</li>
      <li><b>Indoor Only</b> — Cat can come in but cannot go out (profile 3). This is the "curfew" mode.</li>
      <li><b>Unmanaged</b> — No profile restrictions set (profile 0)</li>
    </ul>

    <h2>How Schedules Work</h2>
    <p>A schedule defines a <b>lock time</b> and an <b>unlock time</b> for a cat on selected days.</p>
    <ul>
      <li>At <b>lock time</b>, the cat's profile is set to <b>Indoor Only</b> — it can come in but not go out.</li>
      <li>At <b>unlock time</b>, the profile is set back to <b>Full Access</b>.</li>
      <li><b>Overnight handling:</b> If unlock time is earlier than lock time (e.g. lock at 21:00, unlock at 07:00), the unlock happens the following morning.</li>
    </ul>

    <h2>Lock Modes</h2>
    <ul>
      <li><b>Unlocked</b> — Flap is fully open in both directions</li>
      <li><b>Locked In</b> — Cats can go out but not come in</li>
      <li><b>Locked Out</b> — Cats can come in but not go out</li>
      <li><b>Locked All</b> — Flap is locked in both directions</li>
    </ul>
    <p>Note: Curfew uses per-cat tag profiles, not the device-level lock mode. The lock mode applies to all cats at the device level.</p>

    <h2>Device Info</h2>
    <ul>
      <li><b>Battery:</b> Shown as percentage. Green &gt; 50%, amber 20-50%, red &lt; 20%.</li>
      <li><b>Signal:</b> WiFi signal strength in dBm. Green &gt; -60, amber -60 to -80, red &lt; -80.</li>
    </ul>

    <h2>MQTT for Home Assistant</h2>
    <p>When MQTT is enabled, the service publishes auto-discovery messages to Home Assistant:</p>
    <ul>
      <li>Binary sensors for each cat's curfew state (ON/OFF)</li>
      <li>Sensors for location, battery, signal strength</li>
      <li>Switch entities to control curfew from HA</li>
    </ul>
    <p>MQTT broker settings are auto-discovered when running as an HA addon.</p>

    <h2>Troubleshooting</h2>
    <ul>
      <li><b>No cats/devices:</b> Check your Sure Petcare email and password in Settings. Click Sync to re-fetch.</li>
      <li><b>Curfew not activating:</b> Ensure the cat is associated with a device (DualScan flap). Check the event log for errors.</li>
      <li><b>MQTT not connecting:</b> Verify your broker host/port. In HA addon mode, MQTT is auto-discovered from Supervisor.</li>
      <li><b>Schedule not running:</b> Ensure the schedule is enabled (play/pause icon). Check that the days of week include today.</li>
    </ul>
  </div>
</div>

</div><!-- /container -->

<div class="toast" id="toast"></div>

<script>
const DAY_LABELS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const LOCK_MODES = {0:'Unlocked',1:'Locked In',2:'Locked Out',3:'Locked All'};
const PROFILE_NAMES = {0:'Unmanaged',2:'Full Access',3:'Indoor Only'};
let selectedDays = new Set([0,1,2,3,4,5,6]);
let editingScheduleId = null;
let state = {cats:[],devices:[],events:[],eventTotal:0,lastPoll:null,activeSchedules:0};

// ── API helpers ──
// Ingress base path is injected server-side from X-Ingress-Path header
const BASE = '__INGRESS_PATH__';
// Fix static asset URLs for HA ingress
if (BASE) {
  const fav = document.getElementById('favicon');
  if (fav) fav.href = BASE + '/favicon.ico';
  const logo = document.getElementById('logoImg');
  if (logo) logo.src = BASE + '/paw-logo.png';
}
const api = (path, opts={}) => fetch(BASE + path, opts).then(r=>{if(!r.ok)throw new Error(r.statusText);return r.json()});
const post = (path, body) => api(path, {method:'POST',...(body?{headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}:{})});
const put = (path, body) => api(path, {method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
const del = (path) => api(path, {method:'DELETE'});

// ── Toast ──
function toast(msg, type='success') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast ' + type + ' show';
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove('show'), 3000);
}

// ── Render ──
function renderHeader() {
  const poll = state.lastPoll ? new Date(state.lastPoll).toLocaleTimeString() : '—';
  document.getElementById('headerMeta').innerHTML = `
    <div class="meta-pill"><span class="dot dot-green"></span>Polling</div>
    <div class="meta-pill">Last: ${poll}</div>
    <div class="meta-pill">${state.activeSchedules} schedule${state.activeSchedules!==1?'s':''}</div>
    <button class="btn-sync" id="btnSync" onclick="doSync()">
      <i class="pi pi-sync"></i> Sync
    </button>
  `;
}

function renderCats() {
  const grid = document.getElementById('catGrid');
  if (!state.cats.length) { grid.innerHTML='<div class="empty"><i class="pi pi-info-circle"></i> No cats found. Click <b>Sync</b> to fetch data from Sure Petcare, or check your credentials in Settings.</div>'; return; }
  grid.innerHTML = state.cats.map(c => {
    const locClass = c.location==='inside'?'loc-inside':c.location==='outside'?'loc-outside':'loc-unknown';
    const locIcon = c.location==='inside'?'<i class="pi pi-home"></i>':c.location==='outside'?'<i class="pi pi-sun"></i>':'<i class="pi pi-question-circle"></i>';
    const isOut = c.location==='outside';
    const schedHtml = (c.schedules||[]).map(s => {
      const days = (s.days_of_week||[]).map(d=>DAY_LABELS[d].charAt(0)).join('');
      return `<div class="sched-row">
        <div class="sched-info">
          <span class="sched-name">${esc(s.name)}</span>
          <span class="sched-time">${s.lock_time} → ${s.unlock_time}</span>
          <span class="sched-days">${days}</span>
        </div>
        <div class="sched-actions">
          <button class="btn-xs" title="Edit" onclick='editSched(${JSON.stringify(s).replace(/'/g,"&#39;")})'><i class="pi pi-pencil"></i></button>
          <button class="btn-xs ${s.enabled?'':'off'}" title="${s.enabled?'Disable':'Enable'}" onclick="toggleSched(${s.id})"><i class="pi ${s.enabled?'pi-pause':'pi-play'}"></i></button>
          <button class="btn-xs del" title="Delete" onclick="deleteSched(${s.id})"><i class="pi pi-times"></i></button>
        </div>
      </div>`;
    }).join('');
    return `<div class="cat-card ${c.curfew_active?'curfew-on':''}">
      <div class="cat-top">
        <div class="cat-name">${esc(c.name)}</div>
        <div class="loc-toggle">
          <span class="cat-location ${locClass}">${locIcon} ${c.location}</span>
          <button class="loc-switch ${isOut?'outside':''}" onclick="toggleLocation(${c.id},'${c.location}',this)" title="Toggle location"></button>
        </div>
      </div>
      <div class="cat-status">
        <span class="curfew-badge ${c.curfew_active?'active':'inactive'}">${c.curfew_active?'<i class="pi pi-lock"></i> Curfew On':'<i class="pi pi-lock-open"></i> Free'}</span>
        <span class="profile-tag">${PROFILE_NAMES[c.current_profile] || 'Profile '+c.current_profile}</span>
        ${c.last_activity ? `<span class="profile-tag" title="${new Date(c.last_activity).toLocaleString()}"><i class="pi pi-clock"></i> ${timeAgo(c.last_activity)}</span>` : ''}
      </div>
      <div class="cat-actions">
        <button class="btn btn-lock" ${c.curfew_active?'disabled':''} onclick="curfew(${c.id},'activate',this)"><i class="pi pi-lock"></i> Lock In</button>
        <button class="btn btn-unlock" ${!c.curfew_active?'disabled':''} onclick="curfew(${c.id},'deactivate',this)"><i class="pi pi-lock-open"></i> Free</button>
      </div>
      ${(c.schedules||[]).length?`<div class="cat-schedules"><div class="cat-schedules-label">Schedules</div>${schedHtml}</div>`:''}
    </div>`;
  }).join('');
}

function renderDevices() {
  const grid = document.getElementById('deviceGrid');
  if (!state.devices.length) { grid.innerHTML='<div class="empty"><i class="pi pi-info-circle"></i> No devices found. Sync to discover cat flaps from your Sure Petcare account.</div>'; return; }
  grid.innerHTML = state.devices.map(d => {
    const batt = d.battery_level ?? 0;
    const battClass = batt > 50 ? 'batt-good' : batt > 20 ? 'batt-mid' : 'batt-low';
    const sig = d.signal_strength ?? 0;
    const sigClass = sig > -60 ? 'sig-good' : sig > -80 ? 'sig-mid' : 'sig-weak';
    const sigBars = `<i class="pi pi-wifi ${sigClass}"></i>`;
    return `<div class="device-card">
      <div class="device-top">
        <div class="device-name">${esc(d.name)}</div>
        <span class="device-online ${d.online?'online-yes':'online-no'}"><i class="pi ${d.online?'pi-circle-fill':'pi-circle'}"></i> ${d.online?'Online':'Offline'}</span>
      </div>
      <div class="device-stats">
        <div class="stat">
          <span class="stat-label">Battery</span>
          <span class="stat-value">${batt}%</span>
          <div class="battery-bar"><div class="battery-fill ${battClass}" style="width:${batt}%"></div></div>
        </div>
        <div class="stat">
          <span class="stat-label">Signal</span>
          <span class="stat-value">${sigBars} <span style="font-size:.7rem;color:var(--text-muted)">${sig} dBm</span></span>
        </div>
        <div class="stat">
          <span class="stat-label">Lock Mode</span>
          <span class="stat-value">${LOCK_MODES[d.lock_mode]||'Unknown'}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Voltage</span>
          <span class="stat-value">${d.battery_voltage?.toFixed(2) ?? '—'}V</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderEvents() {
  const list = document.getElementById('eventList');
  if (!state.events.length) { list.innerHTML='<div class="empty"><i class="pi pi-info-circle"></i> No events recorded yet. Events will appear here as curfew schedules run and cat movements are detected.</div>'; return; }
  let html = state.events.map(e => {
    const t = new Date(e.created_at+'Z');
    const time = t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const det = e.details ? Object.entries(e.details).map(([k,v])=>`${k}: ${v}`).join(', ') : '';
    return `<div class="event-row">
      <span class="event-time">${time}</span>
      <span class="event-type et-${e.event_type}">${e.event_type.replace(/_/g,' ')}</span>
      <span class="event-detail">${esc(det)}</span>
    </div>`;
  }).join('');
  const loaded = state.events.length;
  if (loaded < state.eventTotal) {
    html += `<div style="text-align:center;padding:.75rem"><button class="btn-sync" onclick="loadMoreEvents()" id="btnLoadMore"><i class="pi pi-arrow-down"></i> Load More (${loaded}/${state.eventTotal})</button></div>`;
  }
  list.innerHTML = html;
}

async function loadMoreEvents() {
  const btn = document.getElementById('btnLoadMore');
  if (btn) { btn.disabled = true; btn.textContent = 'Loading…'; }
  eventsPage++;
  try {
    const res = await api(`/api/events?limit=${EVENTS_PER_PAGE}&offset=${eventsPage * EVENTS_PER_PAGE}`);
    state.events = state.events.concat(res.events || []);
    state.eventTotal = res.total || state.eventTotal;
    renderEvents();
  } catch(e) { toast('Failed to load events', 'error'); }
}

function renderCatSelect() {
  const sel = document.getElementById('fCat');
  sel.innerHTML = '<option value="" disabled selected>Select a cat…</option>' + state.cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}

function renderDays() {
  document.getElementById('fDays').innerHTML = DAY_LABELS.map((d,i) =>
    `<div class="day-check ${selectedDays.has(i)?'selected':''}" data-day="${i}" onclick="toggleDay(${i})">${d}</div>`
  ).join('');
}

// ── Actions ──
async function refresh() {
  try {
    const [statusRes, eventsRes] = await Promise.all([api('/api/status'), api(`/api/events?limit=${EVENTS_PER_PAGE}&offset=0`)]);
    state.cats = statusRes.cats || [];
    state.devices = statusRes.devices || [];
    state.lastPoll = statusRes.lastPoll;
    state.activeSchedules = statusRes.activeSchedules || 0;
    state.events = eventsRes.events || [];
    state.eventTotal = eventsRes.total || 0;
    eventsPage = 0;
    renderHeader(); renderCats(); renderDevices(); renderEvents(); renderCatSelect();
  } catch(e) { console.error('Refresh failed', e); }
}

async function toggleLocation(catId, current, btn) {
  const newLoc = current === 'inside' ? 'outside' : 'inside';
  btn.disabled = true;
  try {
    await post(`/api/cats/${catId}/location`, { location: newLoc });
    toast(`Moved ${state.cats.find(c=>c.id===catId)?.name||'cat'} → ${newLoc}`);
    await refresh();
  } catch(e) { toast('Failed: '+e.message, 'error'); await refresh(); }
}

async function curfew(catId, action, btn) {
  if (btn) { btn.disabled = true; btn.innerHTML = '<i class="pi pi-spin pi-spinner"></i>'; }
  try {
    await post(`/api/cats/${catId}/curfew/${action}`);
    toast(`Curfew ${action}d`);
    await refresh();
  } catch(e) { toast('Failed: '+e.message, 'error'); await refresh(); }
}

async function toggleSched(id) {
  try { await post(`/api/curfew/${id}/toggle`); toast('Schedule toggled'); await refresh(); }
  catch(e) { toast('Failed', 'error'); }
}

async function deleteSched(id) {
  if (!confirm('Delete this schedule?')) return;
  try { await del(`/api/curfew/${id}`); toast('Schedule deleted'); await refresh(); }
  catch(e) { toast('Failed', 'error'); }
}

function editSched(s) {
  editingScheduleId = s.id;
  document.getElementById('fCat').value = s.cat_id;
  document.getElementById('fName').value = s.name;
  document.getElementById('fLock').value = s.lock_time;
  document.getElementById('fUnlock').value = s.unlock_time;
  selectedDays = new Set(s.days_of_week);
  renderDays();
  document.getElementById('fSubmit').textContent = 'Update Schedule';
  document.getElementById('fCancel').style.display = '';
  // Expand the panel if collapsed
  const panel = document.getElementById('schedPanel');
  const title = panel.previousElementSibling;
  if (panel.classList.contains('collapsed')) {
    panel.classList.remove('collapsed');
    panel.style.maxHeight = panel.scrollHeight + 'px';
    panel.style.opacity = '1';
    title.classList.add('open');
  }
  panel.scrollIntoView({behavior:'smooth'});
}

function cancelEdit() {
  editingScheduleId = null;
  document.getElementById('fCat').selectedIndex = 0;
  document.getElementById('fName').value = '';
  document.getElementById('fLock').value = '21:00';
  document.getElementById('fUnlock').value = '07:00';
  selectedDays = new Set([0,1,2,3,4,5,6]);
  renderDays();
  document.getElementById('fSubmit').textContent = 'Create Schedule';
  document.getElementById('fCancel').style.display = 'none';
}

async function doSync() {
  const btn = document.getElementById('btnSync');
  btn.classList.add('syncing'); btn.textContent = 'Syncing…';
  try { await post('/api/sync'); toast('Synced'); await refresh(); }
  catch(e) { toast('Sync failed', 'error'); }
  btn.classList.remove('syncing');
}

function toggleDay(i) {
  selectedDays.has(i) ? selectedDays.delete(i) : selectedDays.add(i);
  renderDays();
}

function togglePanel(id, titleEl) {
  const panel = document.getElementById(id);
  const isCollapsed = panel.classList.contains('collapsed');
  if (isCollapsed) {
    panel.classList.remove('collapsed');
    panel.style.maxHeight = panel.scrollHeight + 'px';
    panel.style.opacity = '1';
    titleEl.classList.add('open');
  } else {
    panel.style.maxHeight = '0';
    panel.style.opacity = '0';
    panel.classList.add('collapsed');
    titleEl.classList.remove('open');
  }
}

function esc(s) { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }

function timeAgo(dateStr) {
  if (!dateStr) return '';
  const now = Date.now();
  const then = new Date(dateStr).getTime();
  const diff = Math.floor((now - then) / 1000);
  if (diff < 60) return 'just now';
  if (diff < 3600) return Math.floor(diff/60) + ' min ago';
  if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
  return Math.floor(diff/86400) + 'd ago';
}

let eventsPage = 0;
const EVENTS_PER_PAGE = 20;

// ── Form ──
document.getElementById('schedForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const lockTime = document.getElementById('fLock').value;
  const unlockTime = document.getElementById('fUnlock').value;
  if (lockTime === unlockTime) { toast('Lock and unlock times cannot be the same', 'error'); return; }
  if (selectedDays.size === 0) { toast('Select at least one day', 'error'); return; }

  // Check for overlapping schedules on the same cat
  const catId = Number(document.getElementById('fCat').value);
  const cat = state.cats.find(c => c.id === catId);
  if (cat && cat.schedules) {
    const toMin = t => { const [h,m] = t.split(':').map(Number); return h*60+m; };
    const newLock = toMin(lockTime), newUnlock = toMin(unlockTime);
    const overlap = cat.schedules.find(s => {
      if (editingScheduleId === s.id) return false;
      if (!s.enabled) return false;
      const sDays = new Set(s.days_of_week);
      const sharedDays = [...selectedDays].some(d => sDays.has(d));
      if (!sharedDays) return false;
      const sLock = toMin(s.lock_time), sUnlock = toMin(s.unlock_time);
      // Overnight ranges: expand to check overlap
      const newRanges = newLock < newUnlock ? [[newLock,newUnlock]] : [[newLock,1440],[0,newUnlock]];
      const sRanges = sLock < sUnlock ? [[sLock,sUnlock]] : [[sLock,1440],[0,sUnlock]];
      return newRanges.some(([a1,a2]) => sRanges.some(([b1,b2]) => a1 < b2 && b1 < a2));
    });
    if (overlap) {
      toast(`Warning: overlaps with "${overlap.name}" (${overlap.lock_time}-${overlap.unlock_time})`, 'error');
    }
  }

  const btn = document.getElementById('fSubmit');
  const isEdit = editingScheduleId !== null;
  btn.disabled = true; btn.textContent = isEdit ? 'Updating…' : 'Creating…';
  try {
    const body = {
      name: document.getElementById('fName').value,
      lock_time: lockTime,
      unlock_time: unlockTime,
      days_of_week: [...selectedDays].sort(),
    };
    if (isEdit) {
      await put(`/api/curfew/${editingScheduleId}`, body);
      toast('Schedule updated');
    } else {
      body.cat_id = Number(document.getElementById('fCat').value);
      await post('/api/curfew', body);
      toast('Schedule created');
    }
    document.getElementById('fCat').selectedIndex = 0;
    document.getElementById('fName').value = '';
    document.getElementById('fLock').value = '21:00';
    document.getElementById('fUnlock').value = '07:00';
    selectedDays = new Set([0,1,2,3,4,5,6]);
    renderDays();
    editingScheduleId = null;
    btn.textContent = 'Create Schedule';
    document.getElementById('fCancel').style.display = 'none';
    await refresh();
  } catch(e) { toast('Failed: '+e.message, 'error'); }
  btn.disabled = false;
  if (!editingScheduleId) btn.textContent = 'Create Schedule';
});

// ── View switching ──
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const viewId = 'view' + name.charAt(0).toUpperCase() + name.slice(1);
  document.getElementById(viewId).classList.add('active');
  const btnId = 'nav' + name.charAt(0).toUpperCase() + name.slice(1);
  const btn = document.getElementById(btnId);
  if (btn) btn.classList.add('active');
  if (name === 'settings') loadSettings();
}

async function loadSettings() {
  const container = document.getElementById('settingsContent');
  container.innerHTML = '<div class="empty"><i class="pi pi-spin pi-spinner"></i> Loading settings…</div>';
  try {
    const s = await api('/api/settings');
    const ro = s.readonly;
    container.innerHTML = `
      <form id="settingsForm" class="settings-section">
        <h3><i class="pi pi-user"></i> Sure Petcare Credentials</h3>
        <div class="settings-grid">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input class="form-input" id="sEmail" value="${esc(s.email||'')}" ${ro?'disabled':''}>
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <input class="form-input" type="password" id="sPassword" value="${esc(s.password||'')}" placeholder="Enter new password" ${ro?'disabled':''}>
          </div>
        </div>
        <h3 style="margin-top:1rem"><i class="pi pi-sliders-h"></i> General</h3>
        <div class="settings-grid">
          <div class="form-group">
            <label class="form-label">Poll Interval (seconds)</label>
            <input class="form-input" type="number" id="sPoll" value="${s.poll_interval||60}" min="10" max="3600" ${ro?'disabled':''}>
          </div>
          <div class="form-group">
            <label class="form-label">Timezone</label>
            <input class="form-input" id="sTz" value="${esc(s.timezone||'Europe/Amsterdam')}" ${ro?'disabled':''}>
          </div>
          <div class="form-group">
            <label class="form-label">API Key</label>
            <input class="form-input" id="sApiKey" value="${esc(s.api_key||'')}" placeholder="Optional" ${ro?'disabled':''}>
          </div>
        </div>
        <h3 style="margin-top:1rem"><i class="pi pi-share-alt"></i> MQTT</h3>
        <div class="settings-grid">
          <div class="form-group">
            <label class="form-label">MQTT Enabled</label>
            <select class="form-select" id="sMqttEnabled" ${ro?'disabled':''}>
              <option value="true" ${s.mqtt_enabled?'selected':''}>Yes</option>
              <option value="false" ${!s.mqtt_enabled?'selected':''}>No</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">MQTT Host</label>
            <input class="form-input" id="sMqttHost" value="${esc(s.mqtt_host||'')}" ${ro?'disabled':''}>
          </div>
          <div class="form-group">
            <label class="form-label">MQTT Port</label>
            <input class="form-input" type="number" id="sMqttPort" value="${s.mqtt_port||1883}" ${ro?'disabled':''}>
          </div>
          <div class="form-group">
            <label class="form-label">Topic Prefix</label>
            <input class="form-input" id="sMqttPrefix" value="${esc(s.mqtt_topic_prefix||'surepet')}" ${ro?'disabled':''}>
          </div>
        </div>
        ${ro
          ? '<p style="margin-top:1rem;font-size:.8rem;color:var(--text-muted)"><i class="pi pi-info-circle"></i> Settings are managed by Home Assistant. Edit them in the addon configuration page.</p>'
          : '<div style="margin-top:1rem;display:flex;gap:.5rem"><button type="submit" class="btn-submit">Save Settings</button></div>'
        }
      </form>
    `;
    if (!ro) {
      document.getElementById('settingsForm').addEventListener('submit', saveSettings);
    }
  } catch(e) { container.innerHTML = '<div class="empty">Failed to load settings.</div>'; }
}

async function saveSettings(e) {
  e.preventDefault();
  try {
    await put('/api/settings', {
      email: document.getElementById('sEmail').value,
      password: document.getElementById('sPassword').value,
      poll_interval: Number(document.getElementById('sPoll').value),
      timezone: document.getElementById('sTz').value,
      api_key: document.getElementById('sApiKey').value,
      mqtt_enabled: document.getElementById('sMqttEnabled').value,
      mqtt_host: document.getElementById('sMqttHost').value,
      mqtt_port: Number(document.getElementById('sMqttPort').value),
      mqtt_topic_prefix: document.getElementById('sMqttPrefix').value,
    });
    toast('Settings saved. Restart service to apply changes.');
  } catch(e) { toast('Failed to save settings: '+e.message, 'error'); }
}

// ── Skeleton loaders ──
function showSkeletons() {
  const skel = `<div class="skeleton"><div class="skel-line h20 w60"></div><div class="skel-line w40"></div><div class="skel-line w80"></div></div>`;
  document.getElementById('catGrid').innerHTML = skel+skel+skel;
  document.getElementById('deviceGrid').innerHTML = skel;
  document.getElementById('eventList').innerHTML = '<div class="empty" style="padding:1.5rem"><i class="pi pi-spin pi-spinner"></i> Loading events…</div>';
}

// ── Init ──
renderDays();
showSkeletons();
refresh();
setInterval(refresh, 30000);
</script>
</body>
</html>
